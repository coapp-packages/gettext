@import "version.inc";
@import "common.inc";

#product-info
{
    product-name: "gettext";
    version: "${upstream-version}";
    original-source-location: "http://ftp.gnu.org/pub/gnu/gettext/gettext-0.18.1.1.tar.gz";
    original-source-website: "http://www.gnu.org/software/gettext/";
    license: "mixed (GPL and LGPL)";
    packager: "Vincent Povirk <madewokherd@gmail.com>";
}

default
{
    compiler: mingw;
    platform: x86;
 
    uses: mingw="..\libiconv";
 
    targets:
    {
      //"gettext-runtime\mingw-build\libasprintf\.libs\libasprintf-0.dll", // unusable because of deps on mingw, probably not needed anyway

      "gettext-runtime\mingw-build\intl\.libs\libintl-8.dll",
      
	  "gettext-runtime\mingw-build\intl\libintl.h",
	  
      "gettext-runtime\mingw-build\src\.libs\envsubst.exe",
      "gettext-runtime\mingw-build\src\.libs\ngettext.exe",
      "gettext-runtime\mingw-build\src\.libs\gettext.exe"
    };
 
    build-command: @"
      :// TODO: libacl is needed for ACL support. Need to investigate if
      :// we care about this.
    
      :// FIX: In this environment, only USE_WIN32_THREADS should be used.
      :// By default, USE_POSIX_THREADS is defined which will cause a failure
      :// in the compilation of some tests hence the --enable-threads=win32.

      sh coapp-build.sh
      
      copy gettext-runtime\mingw-build\intl\.libs\libintl.dll.a gettext-runtime\mingw-build\intl\.libs\intl.lib

    ";
 
    clean-command: @"
      rd /s /q gettext-runtime\mingw-build
    ";
}

vc10
{
    // Users of this library will still need the mingw build to get libintl.h
    compiler: vc10;
    platform: x86;
 
 	requires: {
		"libiconv-dev[vc10]-${libiconv-version}-x86-${libiconv-publickeytoken}",
	};

    targets:
    {
        "COPKG\gettext\Release\libintl.dll",
        "COPKG\gettext\Release\libintl.lib"
    };
 
    build-command: @"
        msbuild /p:Platform=Win32 /p:Configuration=Release COPKG\gettext\gettext.sln
    ";
 
    clean-command: @"
      if exist COPKG\gettext\Release rmdir /s /q  COPKG\gettext\Release > nul 2> nul
      if exist COPKG\gettext\libintl\Release rmdir /s /q  COPKG\gettext\libintl\Release > nul 2> nul
    ";
}

release
{
	uses: {default, vc10};
}

test
{
	uses: release;
}

package
{
	targets:
	{
        @"COPKG\libintl[vc10]-${package-version}-x86.msi",
        @"COPKG\libintl-dev[vc10]-${package-version}-x86.msi",
        @"COPKG\libintl-dev-common-${package-version}-any.msi",
	};

	build-command: @"
		if ""${BUILT}"" neq ""true"" ptk release
		cd COPKG
		autopackage libintl.autopkg libintl-dev-common.autopkg|| goto failed
        autopackage libintl-dev.autopkg || goto failed
	";

	clean-command: @"del COPKG\*.msi COPKG\*.wixpdb";
}
